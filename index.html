<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกเวลาเรียน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .status-btn { transition: all 0.2s; }
        .status-btn:hover { transform: scale(1.05); }
        .status-present { background: #10b981; color: white; }
        .status-absent { background: #ef4444; color: white; }
        .status-business { background: #f59e0b; color: white; }
        .status-sick { background: #8b5cf6; color: white; }
        .status-late { background: #f97316; color: white; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">ระบบบันทึกเวลาเรียน</h1>
            <p class="text-gray-600 text-center">จัดการข้อมูลการเข้าเรียนของนักเรียน</p>
            
            <!-- Room Code Section -->
            <div id="room-setup" class="mt-6 p-4 bg-blue-50 rounded-lg">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold text-blue-800">รหัสห้องเรียน</h3>
                    <p class="text-sm text-blue-600">ใช้รหัสเดียวกันเพื่อซิงค์ข้อมูลข้ามเครื่อง</p>
                </div>
                <div class="flex flex-col md:flex-row gap-4 items-center justify-center">
                    <div class="flex-1 max-w-md">
                        <input type="text" id="room-code-input" placeholder="กรอกรหัสห้องเรียน (6 หลัก)" 
                               class="w-full p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center font-mono text-lg"
                               maxlength="6">
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="joinRoom()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                            เข้าร่วมห้อง
                        </button>
                        <button onclick="createNewRoom()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                            สร้างห้องใหม่
                        </button>
                        <button onclick="testConnection()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                            ทดสอบ API
                        </button>
                    </div>
                </div>
                <div id="current-room" class="mt-4 text-center hidden">
                    <div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-lg">
                        <span class="font-medium">รหัสห้องปัจจุบัน: </span>
                        <span id="current-room-code" class="font-mono text-lg ml-2"></span>
                        <button onclick="leaveRoom()" class="ml-3 text-red-600 hover:text-red-800 text-sm">
                            ออกจากห้อง
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-center mt-4">
                <div class="flex space-x-2 text-sm">
                    <span class="px-3 py-1 bg-green-500 text-white rounded-full">/ = มาเรียน</span>
                    <span class="px-3 py-1 bg-red-500 text-white rounded-full">ข = ขาดเรียน</span>
                    <span class="px-3 py-1 bg-yellow-500 text-white rounded-full">ล = ลากิจ</span>
                    <span class="px-3 py-1 bg-purple-500 text-white rounded-full">ป = ลาป่วย</span>
                    <span class="px-3 py-1 bg-orange-500 text-white rounded-full">ส = สาย</span>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-xl shadow-lg mb-8">
            <div class="flex border-b">
                <button onclick="showTab('attendance')" id="tab-attendance" class="flex-1 py-4 px-6 text-center font-medium border-b-2 border-blue-500 text-blue-600">บันทึกเวลาเรียน</button>
                <button onclick="showTab('manage')" id="tab-manage" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700">จัดการข้อมูล</button>
                <button onclick="showTab('history')" id="tab-history" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700">ประวัติการเรียน</button>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance-tab" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">เลือกชั้นเรียนและวิชา</h2>
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ชั้นเรียน</label>
                        <select id="class-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">เลือกชั้นเรียน</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">วิชา</label>
                        <select id="subject-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">เลือกวิชา</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">วันที่</label>
                        <input type="date" id="attendance-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <button onclick="loadAttendance()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">โหลดข้อมูลการเรียน</button>
            </div>

            <div id="attendance-grid" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <h3 class="text-lg font-semibold mb-4">บันทึกการเข้าเรียน</h3>
                <div id="student-list" class="space-y-3"></div>
                <button onclick="saveAttendance()" class="mt-6 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">บันทึกข้อมูล</button>
            </div>
        </div>

        <!-- Manage Tab -->
        <div id="manage-tab" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Class Management -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">จัดการชั้นเรียน</h2>
                    <div class="mb-4">
                        <input type="text" id="new-class" placeholder="ชื่อชั้นเรียน" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-3">
                        <button onclick="addClass()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors">เพิ่มชั้นเรียน</button>
                    </div>
                    <div id="class-list" class="space-y-2"></div>
                </div>

                <!-- Subject Management -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">จัดการวิชาเรียน</h2>
                    <div class="mb-4">
                        <input type="text" id="new-subject" placeholder="ชื่อวิชา" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-3">
                        <button onclick="addSubject()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-medium transition-colors">เพิ่มวิชา</button>
                    </div>
                    <div id="subject-list" class="space-y-2"></div>
                </div>
            </div>

            <!-- Student Management -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                <h2 class="text-xl font-semibold mb-4">จัดการนักเรียน</h2>
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="student-name" placeholder="ชื่อนักเรียน" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <input type="text" id="student-id" placeholder="รหัสนักเรียน" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <select id="student-class" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">เลือกชั้นเรียน</option>
                    </select>
                </div>
                <button onclick="addStudent()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors mb-4">เพิ่มนักเรียน</button>
                <div id="student-management-list" class="space-y-2"></div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ค้นหาประวัติการเรียน</h2>
                <div class="grid md:grid-cols-4 gap-4 mb-4">
                    <select id="history-class" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">เลือกชั้นเรียน</option>
                    </select>
                    <select id="history-subject" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">เลือกวิชา</option>
                    </select>
                    <input type="date" id="history-start-date" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <input type="date" id="history-end-date" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <button onclick="searchHistory()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">ค้นหา</button>
            </div>

            <div id="history-results" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <h3 class="text-lg font-semibold mb-4">ผลการค้นหา</h3>
                <div id="history-table" class="overflow-x-auto"></div>
            </div>
        </div>

        <!-- Sync Status -->
        <div class="fixed bottom-4 right-4 space-y-2">
            <div id="sync-status" class="bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg hidden">
                <span id="sync-message">กำลังซิงค์ข้อมูล...</span>
            </div>
            <button onclick="resetSystem()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-lg text-sm">
                รีเซ็ตระบบ
            </button>
        </div>
    </div>

    <script>
        // Configuration
        const API_KEY = '$2a$10$DnAQmJLN1zlG4/4n35Ldh.K66BmA6QD//f11sBhW7l1smrA2x9w4e'; // ใส่ API Key จริงของคุณที่นี่
        let ROOM_CODE = localStorage.getItem('attendance_room_code') || null;
        let BIN_ID = localStorage.getItem('attendance_bin_id') || null;
        let API_URL = BIN_ID ? `https://api.jsonbin.io/v3/b/${BIN_ID}` : null;

        // Data structure
        let appData = {
            classes: ['ม.1/1', 'ม.1/2', 'ม.2/1', 'ม.2/2'], // ข้อมูลตัวอย่าง
            subjects: ['คณิตศาสตร์', 'ภาษาไทย', 'ภาษาอังกฤษ', 'วิทยาศาสตร์'], // ข้อมูลตัวอย่าง
            students: [
                { name: 'นางสาวสมใจ ใจดี', id: '001', class: 'ม.1/1' },
                { name: 'นายสมชาย ดีใจ', id: '002', class: 'ม.1/1' },
                { name: 'นางสาวสมหญิง รักเรียน', id: '003', class: 'ม.1/2' }
            ], // ข้อมูลตัวอย่าง
            attendance: {}
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Check API Key
            if (API_KEY === '$2a$10$YOUR_ACTUAL_API_KEY_HERE') {
                showSyncStatus('⚠️ กรุณาใส่ API Key จริงในโค้ด', true);
                document.getElementById('room-setup').innerHTML = `
                    <div class="text-center p-6 bg-red-50 rounded-lg">
                        <h3 class="text-lg font-semibold text-red-800 mb-2">ต้องการ API Key</h3>
                        <p class="text-red-600 mb-4">กรุณาไปที่ <a href="https://jsonbin.io" target="_blank" class="underline">JSONBin.io</a> เพื่อสร้าง API Key</p>
                        <p class="text-sm text-red-500">แทนที่ '$2a$10$YOUR_ACTUAL_API_KEY_HERE' ในโค้ดด้วย API Key จริงของคุณ</p>
                    </div>
                `;
                return;
            }
            
            // Set today's date
            document.getElementById('attendance-date').valueAsDate = new Date();
            document.getElementById('history-start-date').valueAsDate = new Date();
            document.getElementById('history-end-date').valueAsDate = new Date();
            
            // Show current room if exists
            if (ROOM_CODE) {
                showCurrentRoom();
            }
            
            initializeApp();
        });

        async function initializeApp() {
            // Load from localStorage first
            const localData = localStorage.getItem('attendance_data');
            if (localData) {
                try {
                    const parsedData = JSON.parse(localData);
                    appData = { ...appData, ...parsedData };
                } catch (error) {
                    console.error('Error parsing local data:', error);
                }
            }
            
            refreshAllSelects();
            
            // Only load data if we have a room code
            if (ROOM_CODE && BIN_ID) {
                await loadData();
            } else if (ROOM_CODE && !BIN_ID) {
                // Try to find existing bin for this room
                await findRoomBin();
            }
        }

        // Room management functions
        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        async function testConnection() {
            showSyncStatus('กำลังทดสอบการเชื่อมต่อ API...');
            
            try {
                // Test basic API access by creating a test bin
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: 'API Connection Test'
                };
                
                const response = await fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY,
                        'X-Bin-Name': 'api-test-' + Date.now()
                    },
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Delete the test bin immediately
                    try {
                        await fetch(`https://api.jsonbin.io/v3/b/${data.metadata.id}`, {
                            method: 'DELETE',
                            headers: {
                                'X-Master-Key': API_KEY
                            }
                        });
                    } catch (deleteError) {
                        console.log('Could not delete test bin:', deleteError);
                    }
                    
                    showSyncStatus('✅ API ทำงานปกติ - พร้อมใช้งาน!');
                    setTimeout(hideSyncStatus, 3000);
                } else if (response.status === 401) {
                    showSyncStatus('❌ API Key ไม่ถูกต้อง - กรุณาตรวจสอบ', true);
                    setTimeout(hideSyncStatus, 5000);
                } else if (response.status === 403) {
                    showSyncStatus('❌ API Key ไม่มีสิทธิ์ - กรุณาตรวจสอบ', true);
                    setTimeout(hideSyncStatus, 5000);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Connection test failed:', error);
                showSyncStatus(`❌ ไม่สามารถเชื่อมต่อได้: ${error.message}`, true);
                setTimeout(hideSyncStatus, 5000);
            }
        }

        async function createNewRoom() {
            const newRoomCode = generateRoomCode();
            showSyncStatus('กำลังสร้างห้องเรียนใหม่...');
            
            try {
                // Create new bin with room code
                const response = await fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY,
                        'X-Bin-Name': `attendance-room-${newRoomCode}`
                    },
                    body: JSON.stringify({
                        roomCode: newRoomCode,
                        createdAt: new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        ...appData
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    BIN_ID = data.metadata.id;
                    ROOM_CODE = newRoomCode;
                    API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
                    
                    // Save to localStorage
                    localStorage.setItem('attendance_bin_id', BIN_ID);
                    localStorage.setItem('attendance_room_code', ROOM_CODE);
                    
                    showCurrentRoom();
                    showSyncStatus(`สร้างห้องเรียนสำเร็จ! รหัสห้อง: ${ROOM_CODE}`);
                    setTimeout(hideSyncStatus, 3000);
                } else {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    throw new Error(`Failed to create room: ${response.status}`);
                }
            } catch (error) {
                console.error('Error creating room:', error);
                showSyncStatus(`ไม่สามารถสร้างห้องเรียนได้: ${error.message}`, true);
                setTimeout(hideSyncStatus, 5000);
            }
        }

        async function joinRoom() {
            const roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();
            if (!roomCode || roomCode.length !== 6) {
                alert('กรุณากรอกรหัสห้องเรียน 6 หลัก');
                return;
            }
            
            showSyncStatus('กำลังค้นหาห้องเรียน...');
            
            try {
                // Try to find existing room data by searching through bins
                await findRoomByCode(roomCode);
            } catch (error) {
                console.error('Error joining room:', error);
                showSyncStatus('ไม่พบห้องเรียนนี้ หรือเกิดข้อผิดพลาด', true);
                setTimeout(hideSyncStatus, 3000);
            }
        }

        async function findRoomByCode(roomCode) {
            showSyncStatus('กำลังค้นหาห้องเรียน...');
            
            try {
                // Since we can't list all bins without collection, we'll try to guess the bin ID
                // or use a different approach - for now, we'll just create a new room
                showSyncStatus('ไม่พบห้องเรียน', true);
                
                // Offer to create a new room with this code
                setTimeout(() => {
                    if (confirm(`ไม่พบห้องเรียน "${roomCode}"\n\nต้องการสร้างห้องเรียนใหม่ด้วยรหัสนี้หรือไม่?`)) {
                        createRoomWithCode(roomCode);
                    } else {
                        showSyncStatus('ยกเลิกการเข้าร่วมห้อง', true);
                        setTimeout(hideSyncStatus, 2000);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error finding room:', error);
                showSyncStatus('ไม่พบห้องเรียน', true);
                
                // Offer to create a new room with this code
                setTimeout(() => {
                    if (confirm(`ไม่พบห้องเรียน "${roomCode}"\n\nต้องการสร้างห้องเรียนใหม่ด้วยรหัสนี้หรือไม่?`)) {
                        createRoomWithCode(roomCode);
                    } else {
                        showSyncStatus('ยกเลิกการเข้าร่วมห้อง', true);
                        setTimeout(hideSyncStatus, 2000);
                    }
                }, 1000);
            }
        }
        
        async function loadBinData(binId) {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    headers: {
                        'X-Master-Key': API_KEY
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.record;
                }
            } catch (error) {
                console.log(`Error loading bin ${binId}:`, error);
            }
            return null;
        }
        
        async function loadRoomData(binId, roomCode, existingData = null) {
            try {
                BIN_ID = binId;
                ROOM_CODE = roomCode;
                API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
                
                // Save to localStorage
                localStorage.setItem('attendance_bin_id', BIN_ID);
                localStorage.setItem('attendance_room_code', ROOM_CODE);
                
                // Load the room data
                let roomData = existingData;
                if (!roomData) {
                    roomData = await loadBinData(binId);
                }
                
                if (roomData) {
                    const { roomCode: rc, lastUpdated, ...loadedAppData } = roomData;
                    appData = { ...appData, ...loadedAppData };
                }
                
                showCurrentRoom();
                document.getElementById('room-code-input').value = '';
                refreshAllSelects();
                
                showSyncStatus(`เข้าร่วมห้อง ${roomCode} สำเร็จ!`);
                setTimeout(hideSyncStatus, 2000);
            } catch (error) {
                console.error('Error loading room data:', error);
                showSyncStatus('เกิดข้อผิดพลาดในการโหลดข้อมูล', true);
                setTimeout(hideSyncStatus, 3000);
            }
        }
        
        async function createRoomWithCode(roomCode) {
            ROOM_CODE = roomCode;
            localStorage.setItem('attendance_room_code', ROOM_CODE);
            await createBinForRoom(roomCode);
            showCurrentRoom();
            document.getElementById('room-code-input').value = '';
        }

        async function createBinForRoom(roomCode) {
            try {
                const response = await fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY,
                        'X-Bin-Name': `attendance-room-${roomCode}`
                    },
                    body: JSON.stringify({
                        roomCode: roomCode,
                        ...appData
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    BIN_ID = data.metadata.id;
                    API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
                    localStorage.setItem('attendance_bin_id', BIN_ID);
                    
                    showSyncStatus(`เข้าร่วมห้อง ${roomCode} สำเร็จ`);
                    setTimeout(hideSyncStatus, 2000);
                } else {
                    throw new Error('Failed to create bin for room');
                }
            } catch (error) {
                console.error('Error creating bin for room:', error);
                showSyncStatus('ใช้งานแบบออฟไลน์ในห้องนี้', true);
                setTimeout(hideSyncStatus, 3000);
            }
        }

        function showCurrentRoom() {
            if (ROOM_CODE) {
                document.getElementById('current-room-code').textContent = ROOM_CODE;
                document.getElementById('current-room').classList.remove('hidden');
            }
        }

        function leaveRoom() {
            if (confirm('ต้องการออกจากห้องเรียนนี้หรือไม่?')) {
                // Clear room data
                ROOM_CODE = null;
                BIN_ID = null;
                API_URL = null;
                
                localStorage.removeItem('attendance_room_code');
                localStorage.removeItem('attendance_bin_id');
                
                // Hide current room display
                document.getElementById('current-room').classList.add('hidden');
                
                // Reset to default data
                appData = {
                    classes: ['ม.1/1', 'ม.1/2', 'ม.2/1', 'ม.2/2'],
                    subjects: ['คณิตศาสตร์', 'ภาษาไทย', 'ภาษาอังกฤษ', 'วิทยาศาสตร์'],
                    students: [
                        { name: 'นางสาวสมใจ ใจดี', id: '001', class: 'ม.1/1' },
                        { name: 'นายสมชาย ดีใจ', id: '002', class: 'ม.1/1' },
                        { name: 'นางสาวสมหญิง รักเรียน', id: '003', class: 'ม.1/2' }
                    ],
                    attendance: {}
                };
                
                refreshAllSelects();
                showSyncStatus('ออกจากห้องเรียนแล้ว');
                setTimeout(hideSyncStatus, 2000);
            }
        }

        async function findRoomBin() {
            // This function would implement room discovery
            // For now, it's a placeholder
            showSyncStatus('กำลังค้นหาข้อมูลห้องเรียน...');
            setTimeout(() => {
                showSyncStatus('ไม่พบข้อมูลห้องเรียน - ใช้งานแบบออฟไลน์', true);
                setTimeout(hideSyncStatus, 3000);
            }, 2000);
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active state from all tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('text-gray-500');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            // Add active state to selected tab button
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.add('border-blue-500', 'text-blue-600');
            activeBtn.classList.remove('text-gray-500');
            
            // Refresh data for specific tabs
            if (tabName === 'manage') {
                refreshManagementLists();
            } else if (tabName === 'history') {
                refreshHistorySelects();
            }
        }



        // Data management
        async function loadData() {
            if (!API_URL || !ROOM_CODE) {
                refreshAllSelects();
                return;
            }
            
            showSyncStatus(`กำลังโหลดข้อมูลจากห้อง ${ROOM_CODE}...`);
            try {
                const response = await fetch(API_URL + '/latest', {
                    headers: {
                        'X-Master-Key': API_KEY
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const record = data.record;
                    
                    // Verify this is the correct room
                    if (record.roomCode === ROOM_CODE) {
                        // Extract app data (exclude roomCode and lastUpdated)
                        const { roomCode, lastUpdated, ...loadedAppData } = record;
                        appData = { ...appData, ...loadedAppData };
                        
                        showSyncStatus(`โหลดข้อมูลสำเร็จ (ห้อง: ${ROOM_CODE})`);
                        setTimeout(hideSyncStatus, 2000);
                    } else {
                        throw new Error('Room code mismatch');
                    }
                } else if (response.status === 404) {
                    // Bin not found, create new one for this room
                    await createBinForRoom(ROOM_CODE);
                    return;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                refreshAllSelects();
            } catch (error) {
                console.error('Error loading data:', error);
                showSyncStatus('ใช้งานแบบออฟไลน์ - ข้อมูลจะไม่ซิงค์ข้ามอุปกรณ์', true);
                setTimeout(() => {
                    hideSyncStatus();
                    refreshAllSelects();
                }, 3000);
            }
        }

        async function saveData() {
            // Save to localStorage first
            localStorage.setItem('attendance_data', JSON.stringify(appData));
            
            if (!API_URL || !ROOM_CODE) {
                showSyncStatus('บันทึกข้อมูลในเครื่องสำเร็จ');
                setTimeout(hideSyncStatus, 2000);
                return;
            }
            
            showSyncStatus('กำลังซิงค์ข้อมูลไปยังห้องเรียน...');
            try {
                const dataToSave = {
                    roomCode: ROOM_CODE,
                    lastUpdated: new Date().toISOString(),
                    ...appData
                };
                
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify(dataToSave)
                });
                
                if (response.ok) {
                    showSyncStatus(`ซิงค์ข้อมูลสำเร็จ (ห้อง: ${ROOM_CODE})`);
                    setTimeout(hideSyncStatus, 2000);
                } else if (response.status === 404) {
                    // Bin might have been deleted, create new one for this room
                    await createBinForRoom(ROOM_CODE);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error saving data:', error);
                showSyncStatus('บันทึกในเครื่องสำเร็จ - ไม่สามารถซิงค์ออนไลน์ได้', true);
                setTimeout(hideSyncStatus, 3000);
            }
        }

        function showSyncStatus(message, isError = false) {
            const status = document.getElementById('sync-status');
            const messageEl = document.getElementById('sync-message');
            messageEl.textContent = message;
            status.className = `bg-${isError ? 'red' : 'gray'}-800 text-white px-4 py-2 rounded-lg shadow-lg`;
            status.classList.remove('hidden');
        }

        function hideSyncStatus() {
            document.getElementById('sync-status').classList.add('hidden');
        }

        // Class management
        function addClass() {
            const className = document.getElementById('new-class').value.trim();
            if (className && !appData.classes.includes(className)) {
                appData.classes.push(className);
                document.getElementById('new-class').value = '';
                refreshAllSelects();
                saveData();
            }
        }

        function removeClass(className) {
            if (confirm(`ต้องการลบชั้นเรียน "${className}" หรือไม่?`)) {
                appData.classes = appData.classes.filter(c => c !== className);
                appData.students = appData.students.filter(s => s.class !== className);
                refreshAllSelects();
                saveData();
            }
        }

        // Subject management
        function addSubject() {
            const subjectName = document.getElementById('new-subject').value.trim();
            if (subjectName && !appData.subjects.includes(subjectName)) {
                appData.subjects.push(subjectName);
                document.getElementById('new-subject').value = '';
                refreshAllSelects();
                saveData();
            }
        }

        function removeSubject(subjectName) {
            if (confirm(`ต้องการลบวิชา "${subjectName}" หรือไม่?`)) {
                appData.subjects = appData.subjects.filter(s => s !== subjectName);
                refreshAllSelects();
                saveData();
            }
        }

        // Student management
        function addStudent() {
            const name = document.getElementById('student-name').value.trim();
            const id = document.getElementById('student-id').value.trim();
            const className = document.getElementById('student-class').value;
            
            if (name && id && className) {
                if (!appData.students.find(s => s.id === id)) {
                    appData.students.push({ name, id, class: className });
                    document.getElementById('student-name').value = '';
                    document.getElementById('student-id').value = '';
                    document.getElementById('student-class').value = '';
                    refreshManagementLists();
                    saveData();
                } else {
                    alert('รหัสนักเรียนนี้มีอยู่แล้ว');
                }
            }
        }

        function removeStudent(studentId) {
            if (confirm('ต้องการลบนักเรียนคนนี้หรือไม่?')) {
                appData.students = appData.students.filter(s => s.id !== studentId);
                refreshManagementLists();
                saveData();
            }
        }

        // Attendance management
        function loadAttendance() {
            const className = document.getElementById('class-select').value;
            const subject = document.getElementById('subject-select').value;
            const date = document.getElementById('attendance-date').value;
            
            if (!className || !subject || !date) {
                alert('กรุณาเลือกชั้นเรียน วิชา และวันที่');
                return;
            }
            
            const students = appData.students.filter(s => s.class === className);
            const attendanceKey = `${className}-${subject}-${date}`;
            const existingAttendance = appData.attendance[attendanceKey] || {};
            
            const studentListEl = document.getElementById('student-list');
            studentListEl.innerHTML = '';
            
            students.forEach(student => {
                const studentDiv = document.createElement('div');
                studentDiv.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg';
                studentDiv.innerHTML = `
                    <div>
                        <span class="font-medium">${student.name}</span>
                        <span class="text-gray-500 ml-2">(${student.id})</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="setAttendanceStatus('${student.id}', 'present')" 
                                class="status-btn px-3 py-2 rounded-lg text-sm font-medium ${existingAttendance[student.id] === 'present' ? 'status-present' : 'bg-gray-200 text-gray-700'}">
                            มาเรียน (/)
                        </button>
                        <button onclick="setAttendanceStatus('${student.id}', 'absent')" 
                                class="status-btn px-3 py-2 rounded-lg text-sm font-medium ${existingAttendance[student.id] === 'absent' ? 'status-absent' : 'bg-gray-200 text-gray-700'}">
                            ขาดเรียน (ข)
                        </button>
                        <button onclick="setAttendanceStatus('${student.id}', 'business')" 
                                class="status-btn px-3 py-2 rounded-lg text-sm font-medium ${existingAttendance[student.id] === 'business' ? 'status-business' : 'bg-gray-200 text-gray-700'}">
                            ลากิจ (ล)
                        </button>
                        <button onclick="setAttendanceStatus('${student.id}', 'sick')" 
                                class="status-btn px-3 py-2 rounded-lg text-sm font-medium ${existingAttendance[student.id] === 'sick' ? 'status-sick' : 'bg-gray-200 text-gray-700'}">
                            ลาป่วย (ป)
                        </button>
                        <button onclick="setAttendanceStatus('${student.id}', 'late')" 
                                class="status-btn px-3 py-2 rounded-lg text-sm font-medium ${existingAttendance[student.id] === 'late' ? 'status-late' : 'bg-gray-200 text-gray-700'}">
                            สาย (ส)
                        </button>
                    </div>
                `;
                studentListEl.appendChild(studentDiv);
            });
            
            document.getElementById('attendance-grid').classList.remove('hidden');
        }

        function setAttendanceStatus(studentId, status) {
            const className = document.getElementById('class-select').value;
            const subject = document.getElementById('subject-select').value;
            const date = document.getElementById('attendance-date').value;
            const attendanceKey = `${className}-${subject}-${date}`;
            
            if (!appData.attendance[attendanceKey]) {
                appData.attendance[attendanceKey] = {};
            }
            
            appData.attendance[attendanceKey][studentId] = status;
            
            // Update button styles
            const studentDiv = event.target.closest('.flex.items-center');
            const buttons = studentDiv.querySelectorAll('.status-btn');
            buttons.forEach(btn => {
                btn.className = 'status-btn px-3 py-2 rounded-lg text-sm font-medium bg-gray-200 text-gray-700';
            });
            
            event.target.className = `status-btn px-3 py-2 rounded-lg text-sm font-medium status-${status}`;
        }

        function saveAttendance() {
            saveData();
            alert('บันทึกข้อมูลการเข้าเรียนเรียบร้อยแล้ว');
        }

        // History search
        function searchHistory() {
            const className = document.getElementById('history-class').value;
            const subject = document.getElementById('history-subject').value;
            const startDate = document.getElementById('history-start-date').value;
            const endDate = document.getElementById('history-end-date').value;
            
            if (!className || !subject || !startDate || !endDate) {
                alert('กรุณาเลือกข้อมูลให้ครบถ้วน');
                return;
            }
            
            const students = appData.students.filter(s => s.class === className);
            const results = [];
            
            // Generate date range
            const start = new Date(startDate);
            const end = new Date(endDate);
            const dates = [];
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                dates.push(new Date(d).toISOString().split('T')[0]);
            }
            
            // Build results table
            let tableHTML = `
                <table class="min-w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border border-gray-300 px-4 py-2 text-left">ชื่อนักเรียน</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">รหัส</th>
            `;
            
            dates.forEach(date => {
                tableHTML += `<th class="border border-gray-300 px-2 py-2 text-center text-xs">${date}</th>`;
            });
            
            tableHTML += `
                            <th class="border border-gray-300 px-4 py-2 text-center">สรุป</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            students.forEach(student => {
                let presentCount = 0, absentCount = 0, businessCount = 0, sickCount = 0, lateCount = 0;
                
                tableHTML += `
                    <tr>
                        <td class="border border-gray-300 px-4 py-2">${student.name}</td>
                        <td class="border border-gray-300 px-4 py-2">${student.id}</td>
                `;
                
                dates.forEach(date => {
                    const attendanceKey = `${className}-${subject}-${date}`;
                    const status = appData.attendance[attendanceKey]?.[student.id] || '';
                    
                    let displayStatus = '';
                    let cellClass = 'border border-gray-300 px-2 py-2 text-center text-sm';
                    
                    switch (status) {
                        case 'present':
                            displayStatus = '/';
                            cellClass += ' bg-green-100 text-green-800';
                            presentCount++;
                            break;
                        case 'absent':
                            displayStatus = 'ข';
                            cellClass += ' bg-red-100 text-red-800';
                            absentCount++;
                            break;
                        case 'business':
                            displayStatus = 'ล';
                            cellClass += ' bg-yellow-100 text-yellow-800';
                            businessCount++;
                            break;
                        case 'sick':
                            displayStatus = 'ป';
                            cellClass += ' bg-purple-100 text-purple-800';
                            sickCount++;
                            break;
                        case 'late':
                            displayStatus = 'ส';
                            cellClass += ' bg-orange-100 text-orange-800';
                            lateCount++;
                            break;
                        default:
                            cellClass += ' bg-gray-50';
                    }
                    
                    tableHTML += `<td class="${cellClass}">${displayStatus}</td>`;
                });
                
                tableHTML += `
                    <td class="border border-gray-300 px-4 py-2 text-sm">
                        <div class="text-xs space-y-1">
                            <div>มา: ${presentCount}</div>
                            <div>ขาด: ${absentCount}</div>
                            <div>ลากิจ: ${businessCount}</div>
                            <div>ลาป่วย: ${sickCount}</div>
                            <div>สาย: ${lateCount}</div>
                        </div>
                    </td>
                </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            
            document.getElementById('history-table').innerHTML = tableHTML;
            document.getElementById('history-results').classList.remove('hidden');
        }

        // UI refresh functions
        function refreshAllSelects() {
            refreshClassSelects();
            refreshSubjectSelects();
            refreshManagementLists();
            refreshHistorySelects();
        }

        function refreshClassSelects() {
            const selects = ['class-select', 'student-class', 'history-class'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = '<option value="">เลือกชั้นเรียน</option>';
                appData.classes.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    select.appendChild(option);
                });
                select.value = currentValue;
            });
        }

        function refreshSubjectSelects() {
            const selects = ['subject-select', 'history-subject'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = '<option value="">เลือกวิชา</option>';
                appData.subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    select.appendChild(option);
                });
                select.value = currentValue;
            });
        }

        function refreshManagementLists() {
            // Class list
            const classList = document.getElementById('class-list');
            classList.innerHTML = '';
            appData.classes.forEach(className => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <span>${className}</span>
                    <button onclick="removeClass('${className}')" class="text-red-600 hover:text-red-800 text-sm">ลบ</button>
                `;
                classList.appendChild(div);
            });

            // Subject list
            const subjectList = document.getElementById('subject-list');
            subjectList.innerHTML = '';
            appData.subjects.forEach(subject => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <span>${subject}</span>
                    <button onclick="removeSubject('${subject}')" class="text-red-600 hover:text-red-800 text-sm">ลบ</button>
                `;
                subjectList.appendChild(div);
            });

            // Student list
            const studentList = document.getElementById('student-management-list');
            studentList.innerHTML = '';
            appData.students.forEach(student => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div>
                        <span class="font-medium">${student.name}</span>
                        <span class="text-gray-500 ml-2">(${student.id})</span>
                        <span class="text-blue-600 ml-2">${student.class}</span>
                    </div>
                    <button onclick="removeStudent('${student.id}')" class="text-red-600 hover:text-red-800 text-sm">ลบ</button>
                `;
                studentList.appendChild(div);
            });
        }

        function refreshHistorySelects() {
            refreshClassSelects();
            refreshSubjectSelects();
        }

        // System reset function
        function resetSystem() {
            if (confirm('ต้องการรีเซ็ตระบบและออกจากห้องเรียนหรือไม่?\n\nการดำเนินการนี้จะลบข้อมูลในเครื่องทั้งหมด')) {
                // Clear localStorage
                localStorage.removeItem('attendance_bin_id');
                localStorage.removeItem('attendance_data');
                localStorage.removeItem('attendance_room_code');
                
                // Reset data
                appData = {
                    classes: ['ม.1/1', 'ม.1/2', 'ม.2/1', 'ม.2/2'],
                    subjects: ['คณิตศาสตร์', 'ภาษาไทย', 'ภาษาอังกฤษ', 'วิทยาศาสตร์'],
                    students: [
                        { name: 'นางสาวสมใจ ใจดี', id: '001', class: 'ม.1/1' },
                        { name: 'นายสมชาย ดีใจ', id: '002', class: 'ม.1/1' },
                        { name: 'นางสาวสมหญิง รักเรียน', id: '003', class: 'ม.1/2' }
                    ],
                    attendance: {}
                };
                
                // Reset variables
                ROOM_CODE = null;
                BIN_ID = null;
                API_URL = null;
                
                // Hide current room display
                document.getElementById('current-room').classList.add('hidden');
                
                // Refresh UI
                refreshAllSelects();
                document.getElementById('attendance-grid').classList.add('hidden');
                document.getElementById('history-results').classList.add('hidden');
                
                showSyncStatus('รีเซ็ตระบบเรียบร้อยแล้ว');
                setTimeout(hideSyncStatus, 2000);
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96c916f497f27992',t:'MTc1NDc2MTc2Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
