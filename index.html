<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase configuration (‡πÉ‡∏ä‡πâ public demo database ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á)
        const firebaseConfig = {
            apiKey: "AIzaSyDvwSAmxAPIruGttXllxYzAuridO8S0-WM",
            authDomain: "canva-code-demo.firebaseapp.com",
            databaseURL: "https://canva-code-demo-default-rtdb.firebaseio.com/",
            projectId: "canva-code-demo",
            storageBucket: "canva-code-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abc123def456"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase functions available globally
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        window.firebasePush = push;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .status-btn { transition: all 0.2s; }
        .status-btn:hover { transform: scale(1.05); }
        .status-present { background: #10b981; color: white; }
        .status-absent { background: #ef4444; color: white; }
        .status-business { background: #f59e0b; color: white; }
        .status-sick { background: #8b5cf6; color: white; }
        .status-late { background: #f97316; color: white; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
            <p class="text-gray-600 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
            
            <!-- Room Code Section -->
            <div id="room-setup" class="mt-6 p-4 bg-blue-50 rounded-lg">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold text-blue-800">‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <p class="text-sm text-blue-600">‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p>
                    <div id="github-notice" class="mt-2 p-2 bg-yellow-100 border border-yellow-300 rounded text-xs text-yellow-800 hidden">
                        üìå ‡∏´‡∏≤‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô GitHub Pages: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ HTTPS ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Developer Console (F12) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π log ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                    </div>
                </div>
                <div class="flex flex-col md:flex-row gap-4 items-center justify-center">
                    <div class="flex-1 max-w-md">
                        <input type="text" id="room-code-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (6 ‡∏´‡∏•‡∏±‡∏Å)" 
                               class="w-full p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center font-mono text-lg"
                               maxlength="6">
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="joinRoom()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á
                        </button>
                        <button onclick="createNewRoom()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                        </button>
                        <button onclick="testConnection()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                            ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Firebase
                        </button>
                        <button onclick="testRealTimeSync()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                            ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Sync
                        </button>
                    </div>
                </div>
                <div id="current-room" class="mt-4 text-center hidden">
                    <div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-lg">
                        <span class="font-medium">‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: </span>
                        <span id="current-room-code" class="font-mono text-lg ml-2"></span>
                        <button onclick="leaveRoom()" class="ml-3 text-red-600 hover:text-red-800 text-sm">
                            ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-center mt-4">
                <div class="flex space-x-2 text-sm">
                    <span class="px-3 py-1 bg-green-500 text-white rounded-full">/ = ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                    <span class="px-3 py-1 bg-red-500 text-white rounded-full">‡∏Ç = ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                    <span class="px-3 py-1 bg-yellow-500 text-white rounded-full">‡∏• = ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</span>
                    <span class="px-3 py-1 bg-purple-500 text-white rounded-full">‡∏õ = ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</span>
                    <span class="px-3 py-1 bg-orange-500 text-white rounded-full">‡∏™ = ‡∏™‡∏≤‡∏¢</span>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-xl shadow-lg mb-8">
            <div class="flex border-b">
                <button onclick="showTab('attendance')" id="tab-attendance" class="flex-1 py-4 px-6 text-center font-medium border-b-2 border-blue-500 text-blue-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                <button onclick="showTab('manage')" id="tab-manage" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button onclick="showTab('history')" id="tab-history" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance-tab" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤</h2>
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <select id="class-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏¥‡∏ä‡∏≤</label>
                        <select id="subject-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="attendance-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <button onclick="loadAttendance()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            </div>

            <div id="attendance-grid" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <h3 class="text-lg font-semibold mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <div id="student-list" class="space-y-3"></div>
                <button onclick="saveAttendance()" class="mt-6 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>

        <!-- Manage Tab -->
        <div id="manage-tab" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Class Management -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                    <div class="mb-4">
                        <input type="text" id="new-class" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-3">
                        <button onclick="addClass()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    </div>
                    <div id="class-list" class="space-y-2"></div>
                </div>

                <!-- Subject Management -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                    <div class="mb-4">
                        <input type="text" id="new-subject" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-3">
                        <button onclick="addSubject()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-medium transition-colors">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</button>
                    </div>
                    <div id="subject-list" class="space-y-2"></div>
                </div>
            </div>

            <!-- Student Management -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                <h2 class="text-xl font-semibold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="student-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <input type="text" id="student-id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <select id="student-class" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                    </select>
                </div>
                <button onclick="addStudent()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                <div id="student-management-list" class="space-y-2"></div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <div class="grid md:grid-cols-4 gap-4 mb-4">
                    <select id="history-class" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                    </select>
                    <select id="history-subject" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</option>
                    </select>
                    <input type="date" id="history-start-date" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <input type="date" id="history-end-date" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <button onclick="searchHistory()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </div>

            <div id="history-results" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <h3 class="text-lg font-semibold mb-4">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h3>
                <div id="history-table" class="overflow-x-auto"></div>
            </div>
        </div>

        <!-- Sync Status -->
        <div class="fixed bottom-4 right-4 space-y-2">
            <div id="sync-status" class="bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg hidden">
                <span id="sync-message">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
            </div>
            <button onclick="resetSystem()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-lg text-sm">
                ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>
    </div>

    <script>
        // Configuration - ‡πÉ‡∏ä‡πâ Firebase ‡πÅ‡∏ó‡∏ô JSONBin
        let ROOM_CODE = localStorage.getItem('attendance_room_code') || null;
        let isFirebaseReady = false;
        let roomDataRef = null;
        let unsubscribeListener = null;

        // Data structure
        let appData = {
            classes: ['‡∏°.1/1', '‡∏°.1/2', '‡∏°.2/1', '‡∏°.2/2'], // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
            subjects: ['‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢', '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå'], // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
            students: [
                { name: '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏°‡πÉ‡∏à ‡πÉ‡∏à‡∏î‡∏µ', id: '001', class: '‡∏°.1/1' },
                { name: '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏î‡∏µ‡πÉ‡∏à', id: '002', class: '‡∏°.1/1' },
                { name: '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', id: '003', class: '‡∏°.1/2' }
            ], // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
            attendance: {}
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            document.getElementById('attendance-date').valueAsDate = new Date();
            document.getElementById('history-start-date').valueAsDate = new Date();
            document.getElementById('history-end-date').valueAsDate = new Date();
            
            // Show current room if exists
            if (ROOM_CODE) {
                showCurrentRoom();
            }
            
            // Check if running on GitHub Pages and show notice
            if (location.hostname.includes('github.io')) {
                document.getElementById('github-notice').classList.remove('hidden');
            }
            
            // Check if running on HTTPS (required for Firebase on GitHub Pages)
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                console.warn('Firebase requires HTTPS. Redirecting...');
                if (location.hostname.includes('github.io')) {
                    location.replace('https:' + window.location.href.substring(window.location.protocol.length));
                    return;
                }
            }
            
            // Wait for Firebase to be ready
            setTimeout(() => {
                if (window.firebaseDB) {
                    isFirebaseReady = true;
                    console.log('Firebase initialized successfully');
                    initializeApp();
                } else {
                    console.log('Firebase not available, using offline mode');
                    initializeApp();
                }
            }, 2000); // Increased timeout for GitHub Pages
        });

        async function initializeApp() {
            // Load from localStorage first
            const localData = localStorage.getItem('attendance_data');
            if (localData) {
                try {
                    const parsedData = JSON.parse(localData);
                    appData = { ...appData, ...parsedData };
                } catch (error) {
                    console.error('Error parsing local data:', error);
                }
            }
            
            refreshAllSelects();
            
            // Only load data if we have a room code
            if (ROOM_CODE) {
                await loadData();
            }
        }

        // Room management functions
        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        async function testConnection() {
            showSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...');
            
            try {
                if (!isFirebaseReady || !window.firebaseDB) {
                    throw new Error('Firebase ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                }
                
                // Test Firebase connection by writing and reading test data
                const testRef = window.firebaseRef(window.firebaseDB, 'test/' + Date.now());
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: 'Firebase Connection Test'
                };
                
                await window.firebaseSet(testRef, testData);
                const snapshot = await window.firebaseGet(testRef);
                
                if (snapshot.exists() && snapshot.val().test === true) {
                    // Clean up test data
                    await window.firebaseSet(testRef, null);
                    
                    showSyncStatus('‚úÖ Firebase ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ - ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!');
                    setTimeout(hideSyncStatus, 3000);
                } else {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Firebase connection test failed:', error);
                showSyncStatus(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase: ${error.message}`, true);
                setTimeout(hideSyncStatus, 5000);
            }
        }

        async function testRealTimeSync() {
            if (!ROOM_CODE) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
                return;
            }
            
            showSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö Real-time Sync...');
            
            try {
                if (!isFirebaseReady || !window.firebaseDB) {
                    throw new Error('Firebase ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                }
                
                // Add a test class to trigger sync
                const testClassName = `‡∏ó‡∏î‡∏™‡∏≠‡∏ö-${Date.now()}`;
                appData.classes.push(testClassName);
                
                console.log('Adding test class:', testClassName);
                console.log('Current appData:', appData);
                
                // Save to Firebase
                await saveData();
                
                // Remove test class after 3 seconds
                setTimeout(() => {
                    appData.classes = appData.classes.filter(c => c !== testClassName);
                    saveData();
                    refreshAllSelects();
                    showSyncStatus('‡∏ó‡∏î‡∏™‡∏≠‡∏ö Real-time Sync ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
                    setTimeout(hideSyncStatus, 2000);
                }, 3000);
                
                refreshAllSelects();
                showSyncStatus('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô');
                
            } catch (error) {
                console.error('Real-time sync test failed:', error);
                showSyncStatus(`‚ùå ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Sync ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`, true);
                setTimeout(hideSyncStatus, 5000);
            }
        }

        async function createNewRoom() {
            const newRoomCode = generateRoomCode();
            showSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà...');
            
            try {
                if (!isFirebaseReady || !window.firebaseDB) {
                    // Fallback: Create room in offline mode
                    console.log('Firebase not available, creating offline room');
                    ROOM_CODE = newRoomCode;
                    localStorage.setItem('attendance_room_code', ROOM_CODE);
                    showCurrentRoom();
                    showSyncStatus(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á: ${ROOM_CODE} (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå)`);
                    setTimeout(hideSyncStatus, 4000);
                    return;
                }
                
                // Create room data in Firebase
                const roomRef = window.firebaseRef(window.firebaseDB, `rooms/${newRoomCode}`);
                const roomData = {
                    roomCode: newRoomCode,
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    ...appData
                };
                
                await window.firebaseSet(roomRef, roomData);
                
                ROOM_CODE = newRoomCode;
                localStorage.setItem('attendance_room_code', ROOM_CODE);
                
                // Set up real-time listener for this room
                setupRoomListener(newRoomCode);
                
                showCurrentRoom();
                showSyncStatus(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á: ${ROOM_CODE}`);
                setTimeout(hideSyncStatus, 3000);
                
            } catch (error) {
                console.error('Error creating room:', error);
                // Fallback to offline mode
                ROOM_CODE = newRoomCode;
                localStorage.setItem('attendance_room_code', ROOM_CODE);
                showCurrentRoom();
                showSyncStatus(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå: ${ROOM_CODE} (Firebase ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)`, true);
                setTimeout(hideSyncStatus, 5000);
            }
        }

        async function joinRoom() {
            const roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();
            if (!roomCode || roomCode.length !== 6) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 6 ‡∏´‡∏•‡∏±‡∏Å');
                return;
            }
            
            showSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...');
            
            try {
                if (!isFirebaseReady || !window.firebaseDB) {
                    throw new Error('Firebase ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                }
                
                // Check if room exists in Firebase
                const roomRef = window.firebaseRef(window.firebaseDB, `rooms/${roomCode}`);
                const snapshot = await window.firebaseGet(roomRef);
                
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    
                    // Load room data
                    const { roomCode: rc, createdAt, lastUpdated, ...loadedAppData } = roomData;
                    appData = { ...appData, ...loadedAppData };
                    
                    ROOM_CODE = roomCode;
                    localStorage.setItem('attendance_room_code', ROOM_CODE);
                    
                    // Set up real-time listener for this room
                    setupRoomListener(roomCode);
                    
                    showCurrentRoom();
                    document.getElementById('room-code-input').value = '';
                    refreshAllSelects();
                    
                    showSyncStatus(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á ${roomCode} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                    setTimeout(hideSyncStatus, 2000);
                } else {
                    // Room not found, offer to create
                    showSyncStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', true);
                    setTimeout(() => {
                        if (confirm(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô "${roomCode}"\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                            createRoomWithCode(roomCode);
                        } else {
                            showSyncStatus('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á', true);
                            setTimeout(hideSyncStatus, 2000);
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('Error joining room:', error);
                showSyncStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', true);
                setTimeout(hideSyncStatus, 3000);
            }
        }

        // Firebase-specific functions
        function setupRoomListener(roomCode) {
            // Clean up existing listener
            if (unsubscribeListener) {
                unsubscribeListener();
            }
            
            if (!isFirebaseReady || !window.firebaseDB) {
                console.log('Firebase not ready for listener setup');
                return;
            }
            
            console.log(`Setting up listener for room: ${roomCode}`);
            
            // Set up real-time listener for room data changes
            roomDataRef = window.firebaseRef(window.firebaseDB, `rooms/${roomCode}`);
            unsubscribeListener = window.firebaseOnValue(roomDataRef, (snapshot) => {
                console.log('Firebase data changed:', snapshot.exists());
                
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    console.log('Received room data:', roomData);
                    
                    const { roomCode: rc, createdAt, lastUpdated, ...loadedAppData } = roomData;
                    
                    // Compare data more carefully
                    const currentDataString = JSON.stringify(appData);
                    const newDataString = JSON.stringify(loadedAppData);
                    
                    if (currentDataString !== newDataString) {
                        console.log('Data is different, updating...');
                        appData = { ...appData, ...loadedAppData };
                        refreshAllSelects();
                        
                        // Show sync notification
                        showSyncStatus('üì° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß');
                        setTimeout(hideSyncStatus, 2000);
                    } else {
                        console.log('Data is the same, no update needed');
                    }
                } else {
                    console.log('No data exists in Firebase');
                }
            }, (error) => {
                console.error('Firebase listener error:', error);
                showSyncStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', true);
                setTimeout(hideSyncStatus, 3000);
            });
        }
        
        async function createRoomWithCode(roomCode) {
            try {
                if (!isFirebaseReady || !window.firebaseDB) {
                    throw new Error('Firebase ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                }
                
                const roomRef = window.firebaseRef(window.firebaseDB, `rooms/${roomCode}`);
                const roomData = {
                    roomCode: roomCode,
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    ...appData
                };
                
                await window.firebaseSet(roomRef, roomData);
                
                ROOM_CODE = roomCode;
                localStorage.setItem('attendance_room_code', ROOM_CODE);
                
                setupRoomListener(roomCode);
                showCurrentRoom();
                document.getElementById('room-code-input').value = '';
                
                showSyncStatus(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á ${roomCode} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                setTimeout(hideSyncStatus, 2000);
            } catch (error) {
                console.error('Error creating room with code:', error);
                showSyncStatus('‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ', true);
                setTimeout(hideSyncStatus, 3000);
            }
        }



        function showCurrentRoom() {
            if (ROOM_CODE) {
                document.getElementById('current-room-code').textContent = ROOM_CODE;
                document.getElementById('current-room').classList.remove('hidden');
            }
        }

        function leaveRoom() {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                // Clean up Firebase listener
                if (unsubscribeListener) {
                    unsubscribeListener();
                    unsubscribeListener = null;
                }
                
                // Clear room data
                ROOM_CODE = null;
                roomDataRef = null;
                
                localStorage.removeItem('attendance_room_code');
                
                // Hide current room display
                document.getElementById('current-room').classList.add('hidden');
                
                // Reset to default data
                appData = {
                    classes: ['‡∏°.1/1', '‡∏°.1/2', '‡∏°.2/1', '‡∏°.2/2'],
                    subjects: ['‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢', '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå'],
                    students: [
                        { name: '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏°‡πÉ‡∏à ‡πÉ‡∏à‡∏î‡∏µ', id: '001', class: '‡∏°.1/1' },
                        { name: '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏î‡∏µ‡πÉ‡∏à', id: '002', class: '‡∏°.1/1' },
                        { name: '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', id: '003', class: '‡∏°.1/2' }
                    ],
                    attendance: {}
                };
                
                refreshAllSelects();
                showSyncStatus('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
                setTimeout(hideSyncStatus, 2000);
            }
        }



        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active state from all tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('text-gray-500');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            // Add active state to selected tab button
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.add('border-blue-500', 'text-blue-600');
            activeBtn.classList.remove('text-gray-500');
            
            // Refresh data for specific tabs
            if (tabName === 'manage') {
                refreshManagementLists();
            } else if (tabName === 'history') {
                refreshHistorySelects();
            }
        }



        // Data management
        async function loadData() {
            if (!ROOM_CODE) {
                refreshAllSelects();
                return;
            }
            
            if (!isFirebaseReady || !window.firebaseDB) {
                refreshAllSelects();
                return;
            }
            
            showSyncStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á ${ROOM_CODE}...`);
            try {
                const roomRef = window.firebaseRef(window.firebaseDB, `rooms/${ROOM_CODE}`);
                const snapshot = await window.firebaseGet(roomRef);
                
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    const { roomCode, createdAt, lastUpdated, ...loadedAppData } = roomData;
                    appData = { ...appData, ...loadedAppData };
                    
                    // Set up real-time listener
                    setupRoomListener(ROOM_CODE);
                    
                    showSyncStatus(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏´‡πâ‡∏≠‡∏á: ${ROOM_CODE})`);
                    setTimeout(hideSyncStatus, 2000);
                } else {
                    // Room not found, create it
                    await createRoomWithCode(ROOM_CODE);
                }
                
                refreshAllSelects();
            } catch (error) {
                console.error('Error loading data:', error);
                showSyncStatus('‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', true);
                setTimeout(() => {
                    hideSyncStatus();
                    refreshAllSelects();
                }, 3000);
            }
        }

        async function saveData() {
            // Save to localStorage first
            localStorage.setItem('attendance_data', JSON.stringify(appData));
            
            if (!ROOM_CODE) {
                showSyncStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                setTimeout(hideSyncStatus, 2000);
                return;
            }
            
            if (!isFirebaseReady || !window.firebaseDB) {
                showSyncStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - Firebase ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', true);
                setTimeout(hideSyncStatus, 3000);
                return;
            }
            
            showSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...');
            try {
                const roomRef = window.firebaseRef(window.firebaseDB, `rooms/${ROOM_CODE}`);
                const dataToSave = {
                    roomCode: ROOM_CODE,
                    lastUpdated: new Date().toISOString(),
                    ...appData
                };
                
                await window.firebaseSet(roomRef, dataToSave);
                
                showSyncStatus(`‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏´‡πâ‡∏≠‡∏á: ${ROOM_CODE})`);
                setTimeout(hideSyncStatus, 2000);
            } catch (error) {
                console.error('Error saving data:', error);
                showSyncStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏î‡πâ', true);
                setTimeout(hideSyncStatus, 3000);
            }
        }

        function showSyncStatus(message, isError = false) {
            const status = document.getElementById('sync-status');
            const messageEl = document.getElementById('sync-message');
            messageEl.textContent = message;
            status.className = `bg-${isError ? 'red' : 'gray'}-800 text-white px-4 py-2 rounded-lg shadow-lg`;
            status.classList.remove('hidden');
        }

        function hideSyncStatus() {
            document.getElementById('sync-status').classList.add('hidden');
        }

        // Class management
        function addClass() {
            const className = document.getElementById('new-class').value.trim();
            if (className && !appData.classes.includes(className)) {
                appData.classes.push(className);
                document.getElementById('new-class').value = '';
                refreshAllSelects();
                saveData();
            }
        }

        function removeClass(className) {
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô "${className}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                appData.classes = appData.classes.filter(c => c !== className);
                appData.students = appData.students.filter(s => s.class !== className);
                refreshAllSelects();
                saveData();
            }
        }

        // Subject management
        function addSubject() {
            const subjectName = document.getElementById('new-subject').value.trim();
            if (subjectName && !appData.subjects.includes(subjectName)) {
                appData.subjects.push(subjectName);
                document.getElementById('new-subject').value = '';
                refreshAllSelects();
                saveData();
            }
        }

        function removeSubject(subjectName) {
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤ "${subjectName}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                appData.subjects = appData.subjects.filter(s => s !== subjectName);
                refreshAllSelects();
                saveData();
            }
        }

        // Student management
        function addStudent() {
            const name = document.getElementById('student-name').value.trim();
            const id = document.getElementById('student-id').value.trim();
            const className = document.getElementById('student-class').value;
            
            if (name && id && className) {
                if (!appData.students.find(s => s.id === id)) {
                    appData.students.push({ name, id, class: className });
                    document.getElementById('student-name').value = '';
                    document.getElementById('student-id').value = '';
                    document.getElementById('student-class').value = '';
                    refreshManagementLists();
                    saveData();
                } else {
                    alert('‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                }
            }
        }

        function removeStudent(studentId) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                appData.students = appData.students.filter(s => s.id !== studentId);
                refreshManagementLists();
                saveData();
            }
        }

        // Attendance management
        function loadAttendance() {
            const className = document.getElementById('class-select').value;
            const subject = document.getElementById('subject-select').value;
            const date = document.getElementById('attendance-date').value;
            
            if (!className || !subject || !date) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
                return;
            }
            
            const students = appData.students.filter(s => s.class === className);
            const attendanceKey = `${className}-${subject}-${date}`;
            const existingAttendance = appData.attendance[attendanceKey] || {};
            
            const studentListEl = document.getElementById('student-list');
            studentListEl.innerHTML = '';
            
            students.forEach(student => {
                const studentDiv = document.createElement('div');
                studentDiv.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg';
                studentDiv.innerHTML = `
                    <div>
                        <span class="font-medium">${student.name}</span>
                        <span class="text-gray-500 ml-2">(${student.id})</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="setAttendanceStatus('${student.id}', 'present')" 
                                class="status-btn px-3 py-2 rounded-lg text-sm font-medium ${existingAttendance[student.id] === 'present' ? 'status-present' : 'bg-gray-200 text-gray-700'}">
                            ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (/)
                        </button>
                        <button onclick="setAttendanceStatus('${student.id}', 'absent')" 
                                class="status-btn px-3 py-2 rounded-lg text-sm font-medium ${existingAttendance[student.id] === 'absent' ? 'status-absent' : 'bg-gray-200 text-gray-700'}">
                            ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏Ç)
                        </button>
                        <button onclick="setAttendanceStatus('${student.id}', 'business')" 
                                class="status-btn px-3 py-2 rounded-lg text-sm font-medium ${existingAttendance[student.id] === 'business' ? 'status-business' : 'bg-gray-200 text-gray-700'}">
                            ‡∏•‡∏≤‡∏Å‡∏¥‡∏à (‡∏•)
                        </button>
                        <button onclick="setAttendanceStatus('${student.id}', 'sick')" 
                                class="status-btn px-3 py-2 rounded-lg text-sm font-medium ${existingAttendance[student.id] === 'sick' ? 'status-sick' : 'bg-gray-200 text-gray-700'}">
                            ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (‡∏õ)
                        </button>
                        <button onclick="setAttendanceStatus('${student.id}', 'late')" 
                                class="status-btn px-3 py-2 rounded-lg text-sm font-medium ${existingAttendance[student.id] === 'late' ? 'status-late' : 'bg-gray-200 text-gray-700'}">
                            ‡∏™‡∏≤‡∏¢ (‡∏™)
                        </button>
                    </div>
                `;
                studentListEl.appendChild(studentDiv);
            });
            
            document.getElementById('attendance-grid').classList.remove('hidden');
        }

        function setAttendanceStatus(studentId, status) {
            const className = document.getElementById('class-select').value;
            const subject = document.getElementById('subject-select').value;
            const date = document.getElementById('attendance-date').value;
            const attendanceKey = `${className}-${subject}-${date}`;
            
            if (!appData.attendance[attendanceKey]) {
                appData.attendance[attendanceKey] = {};
            }
            
            appData.attendance[attendanceKey][studentId] = status;
            
            // Update button styles
            const studentDiv = event.target.closest('.flex.items-center');
            const buttons = studentDiv.querySelectorAll('.status-btn');
            buttons.forEach(btn => {
                btn.className = 'status-btn px-3 py-2 rounded-lg text-sm font-medium bg-gray-200 text-gray-700';
            });
            
            event.target.className = `status-btn px-3 py-2 rounded-lg text-sm font-medium status-${status}`;
        }

        function saveAttendance() {
            saveData();
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }

        // History search
        function searchHistory() {
            const className = document.getElementById('history-class').value;
            const subject = document.getElementById('history-subject').value;
            const startDate = document.getElementById('history-start-date').value;
            const endDate = document.getElementById('history-end-date').value;
            
            if (!className || !subject || !startDate || !endDate) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }
            
            const students = appData.students.filter(s => s.class === className);
            const results = [];
            
            // Generate date range
            const start = new Date(startDate);
            const end = new Date(endDate);
            const dates = [];
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                dates.push(new Date(d).toISOString().split('T')[0]);
            }
            
            // Build results table
            let tableHTML = `
                <table class="min-w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border border-gray-300 px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">‡∏£‡∏´‡∏±‡∏™</th>
            `;
            
            dates.forEach(date => {
                tableHTML += `<th class="border border-gray-300 px-2 py-2 text-center text-xs">${date}</th>`;
            });
            
            tableHTML += `
                            <th class="border border-gray-300 px-4 py-2 text-center">‡∏™‡∏£‡∏∏‡∏õ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            students.forEach(student => {
                let presentCount = 0, absentCount = 0, businessCount = 0, sickCount = 0, lateCount = 0;
                
                tableHTML += `
                    <tr>
                        <td class="border border-gray-300 px-4 py-2">${student.name}</td>
                        <td class="border border-gray-300 px-4 py-2">${student.id}</td>
                `;
                
                dates.forEach(date => {
                    const attendanceKey = `${className}-${subject}-${date}`;
                    const status = appData.attendance[attendanceKey]?.[student.id] || '';
                    
                    let displayStatus = '';
                    let cellClass = 'border border-gray-300 px-2 py-2 text-center text-sm';
                    
                    switch (status) {
                        case 'present':
                            displayStatus = '/';
                            cellClass += ' bg-green-100 text-green-800';
                            presentCount++;
                            break;
                        case 'absent':
                            displayStatus = '‡∏Ç';
                            cellClass += ' bg-red-100 text-red-800';
                            absentCount++;
                            break;
                        case 'business':
                            displayStatus = '‡∏•';
                            cellClass += ' bg-yellow-100 text-yellow-800';
                            businessCount++;
                            break;
                        case 'sick':
                            displayStatus = '‡∏õ';
                            cellClass += ' bg-purple-100 text-purple-800';
                            sickCount++;
                            break;
                        case 'late':
                            displayStatus = '‡∏™';
                            cellClass += ' bg-orange-100 text-orange-800';
                            lateCount++;
                            break;
                        default:
                            cellClass += ' bg-gray-50';
                    }
                    
                    tableHTML += `<td class="${cellClass}">${displayStatus}</td>`;
                });
                
                tableHTML += `
                    <td class="border border-gray-300 px-4 py-2 text-sm">
                        <div class="text-xs space-y-1">
                            <div>‡∏°‡∏≤: ${presentCount}</div>
                            <div>‡∏Ç‡∏≤‡∏î: ${absentCount}</div>
                            <div>‡∏•‡∏≤‡∏Å‡∏¥‡∏à: ${businessCount}</div>
                            <div>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢: ${sickCount}</div>
                            <div>‡∏™‡∏≤‡∏¢: ${lateCount}</div>
                        </div>
                    </td>
                </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            
            document.getElementById('history-table').innerHTML = tableHTML;
            document.getElementById('history-results').classList.remove('hidden');
        }

        // UI refresh functions
        function refreshAllSelects() {
            refreshClassSelects();
            refreshSubjectSelects();
            refreshManagementLists();
            refreshHistorySelects();
        }

        function refreshClassSelects() {
            const selects = ['class-select', 'student-class', 'history-class'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>';
                appData.classes.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    select.appendChild(option);
                });
                select.value = currentValue;
            });
        }

        function refreshSubjectSelects() {
            const selects = ['subject-select', 'history-subject'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</option>';
                appData.subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    select.appendChild(option);
                });
                select.value = currentValue;
            });
        }

        function refreshManagementLists() {
            // Class list
            const classList = document.getElementById('class-list');
            classList.innerHTML = '';
            appData.classes.forEach(className => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <span>${className}</span>
                    <button onclick="removeClass('${className}')" class="text-red-600 hover:text-red-800 text-sm">‡∏•‡∏ö</button>
                `;
                classList.appendChild(div);
            });

            // Subject list
            const subjectList = document.getElementById('subject-list');
            subjectList.innerHTML = '';
            appData.subjects.forEach(subject => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <span>${subject}</span>
                    <button onclick="removeSubject('${subject}')" class="text-red-600 hover:text-red-800 text-sm">‡∏•‡∏ö</button>
                `;
                subjectList.appendChild(div);
            });

            // Student list
            const studentList = document.getElementById('student-management-list');
            studentList.innerHTML = '';
            appData.students.forEach(student => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div>
                        <span class="font-medium">${student.name}</span>
                        <span class="text-gray-500 ml-2">(${student.id})</span>
                        <span class="text-blue-600 ml-2">${student.class}</span>
                    </div>
                    <button onclick="removeStudent('${student.id}')" class="text-red-600 hover:text-red-800 text-sm">‡∏•‡∏ö</button>
                `;
                studentList.appendChild(div);
            });
        }

        function refreshHistorySelects() {
            refreshClassSelects();
            refreshSubjectSelects();
        }

        // System reset function
        function resetSystem() {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')) {
                // Clean up Firebase listener
                if (unsubscribeListener) {
                    unsubscribeListener();
                    unsubscribeListener = null;
                }
                
                // Clear localStorage
                localStorage.removeItem('attendance_data');
                localStorage.removeItem('attendance_room_code');
                
                // Reset data
                appData = {
                    classes: ['‡∏°.1/1', '‡∏°.1/2', '‡∏°.2/1', '‡∏°.2/2'],
                    subjects: ['‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢', '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå'],
                    students: [
                        { name: '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏°‡πÉ‡∏à ‡πÉ‡∏à‡∏î‡∏µ', id: '001', class: '‡∏°.1/1' },
                        { name: '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏î‡∏µ‡πÉ‡∏à', id: '002', class: '‡∏°.1/1' },
                        { name: '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', id: '003', class: '‡∏°.1/2' }
                    ],
                    attendance: {}
                };
                
                // Reset variables
                ROOM_CODE = null;
                roomDataRef = null;
                
                // Hide current room display
                document.getElementById('current-room').classList.add('hidden');
                
                // Refresh UI
                refreshAllSelects();
                document.getElementById('attendance-grid').classList.add('hidden');
                document.getElementById('history-results').classList.add('hidden');
                
                showSyncStatus('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                setTimeout(hideSyncStatus, 2000);
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96c94e5486487dbb',t:'MTc1NDc2NDAzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
