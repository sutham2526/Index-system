<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .calendar-day {
            transition: all 0.2s ease;
        }
        .calendar-day:hover {
            background-color: #e5e7eb;
        }
        .calendar-day.selected {
            background-color: #3b82f6;
            color: white;
        }
        .calendar-day.disabled {
            color: #d1d5db;
            cursor: not-allowed;
        }
        .calendar-day.has-data {
            position: relative;
        }
        .calendar-day.has-data::after {
            content: '‚óè';
            position: absolute;
            top: 2px;
            right: 4px;
            color: #ef4444;
            font-size: 16px;
            font-weight: bold;
        }
        .status-btn {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .status-btn.active {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-800 mb-2">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
            <p class="text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
        </div>

        <!-- Navigation -->
        <div class="flex justify-center mb-8">
            <div class="bg-white rounded-lg shadow-lg p-2 flex space-x-2">
                <button onclick="showTab('attendance')" id="tab-attendance" class="px-6 py-3 rounded-lg font-medium transition-all duration-200 bg-indigo-600 text-white">
                    üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                </button>
                <button onclick="showTab('manage')" id="tab-manage" class="px-6 py-3 rounded-lg font-medium transition-all duration-200 text-gray-600 hover:bg-gray-100">
                    ‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
                <button onclick="showTab('history')" id="tab-history" class="px-6 py-3 rounded-lg font-medium transition-all duration-200 text-gray-600 hover:bg-gray-100">
                    üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="max-w-6xl mx-auto">
            <!-- Attendance Tab -->
            <div id="attendance-tab" class="tab-content">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                    
                    <!-- Date Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <div id="calendar" class="bg-gray-50 p-4 rounded-lg"></div>
                    </div>

                    <!-- Room and Subject Selection -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                            <select id="room-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</label>
                            <select id="subject-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Student List -->
                    <div id="student-list" class="hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border border-gray-300 px-4 py-2 text-left">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    </tr>
                                </thead>
                                <tbody id="student-tbody">
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-6 text-center">
                            <button onclick="saveAttendance()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium transition-colors duration-200">
                                üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Tab -->
            <div id="manage-tab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Room Management -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üè´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                            <div class="flex gap-2">
                                <input type="text" id="new-room-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <button onclick="addRoom()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</label>
                            <div id="room-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="clearAllRooms()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        </div>
                    </div>

                    <!-- Subject Management -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìö ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h2>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà</label>
                            <div class="flex gap-2">
                                <input type="text" id="new-subject-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <button onclick="addSubject()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</label>
                            <div id="subject-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="clearAllSubjects()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        </div>
                    </div>
                </div>

                <!-- Student Management Modal -->
                <div id="student-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-xl font-bold text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á: <span id="modal-room-name"></span></h3>
                                    <button onclick="closeStudentModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                                </div>

                                <!-- Add Student Form -->
                                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                    <h4 class="font-semibold mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <input type="number" id="student-number" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" class="p-2 border rounded-lg">
                                        <input type="text" id="student-id" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß" class="p-2 border rounded-lg">
                                        <input type="text" id="student-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" class="p-2 border rounded-lg">
                                    </div>
                                    <div class="mt-3 flex gap-2">
                                        <button onclick="addStudent()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                                        <input type="file" id="excel-file" accept=".xlsx,.xls" class="hidden" onchange="importFromExcel()">
                                        <button onclick="document.getElementById('excel-file').click()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel</button>
                                    </div>
                                </div>

                                <!-- Student List -->
                                <div class="overflow-x-auto">
                                    <table class="w-full border-collapse border border-gray-300">
                                        <thead>
                                            <tr class="bg-gray-100">
                                                <th class="border border-gray-300 px-4 py-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                                <th class="border border-gray-300 px-4 py-2">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
                                                <th class="border border-gray-300 px-4 py-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                                <th class="border border-gray-300 px-4 py-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modal-student-list">
                                        </tbody>
                                    </table>
                                </div>

                                <div class="mt-6 flex justify-end gap-2">
                                    <button onclick="saveStudents()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                                    <button onclick="closeStudentModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">‡∏õ‡∏¥‡∏î</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history-tab" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                    
                    <!-- Date Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <div id="history-calendar" class="bg-gray-50 p-4 rounded-lg"></div>
                    </div>

                    <!-- Room and Subject Selection -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                            <select id="history-room-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</label>
                            <select id="history-subject-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
                            </select>
                        </div>
                    </div>

                    <div class="text-center mb-6">
                        <button onclick="loadHistory()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-lg font-medium mr-4">
                            üîç ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                        <button onclick="deleteSelectedHistory()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium mr-4">
                            üóëÔ∏è ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                        </button>
                        <button onclick="deleteAllHistory()" class="bg-red-800 hover:bg-red-900 text-white px-6 py-3 rounded-lg font-medium">
                            üóëÔ∏è ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </div>

                    <!-- History Results -->
                    <div id="history-results" class="hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border border-gray-300 px-4 py-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                        <th class="border border-gray-300 px-4 py-2">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
                                        <th class="border border-gray-300 px-4 py-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th class="border border-gray-300 px-4 py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    </tr>
                                </thead>
                                <tbody id="history-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentDate = new Date();
        let selectedDate = null;
        let currentRoom = null;
        let rooms = JSON.parse(localStorage.getItem('rooms')) || [];
        let subjects = JSON.parse(localStorage.getItem('subjects')) || [];
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || {};
        
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyAUDEJkFnG-ZwCws0X-RGlST_MOhAwcW4ffn5jO51094vrmcEjjUJR7WTI6zo2Abpu/exec';

        // Status configurations
        const statusConfig = {
            'present': { label: '/', color: 'bg-green-50', activeColor: 'bg-green-400', textColor: 'text-green-600' },
            'absent': { label: '‡∏Ç', color: 'bg-red-50', activeColor: 'bg-red-400', textColor: 'text-red-600' },
            'business': { label: '‡∏•', color: 'bg-purple-50', activeColor: 'bg-purple-400', textColor: 'text-purple-600' },
            'sick': { label: '‡∏õ', color: 'bg-orange-50', activeColor: 'bg-orange-400', textColor: 'text-orange-600' },
            'activity': { label: '‡∏Å', color: 'bg-yellow-50', activeColor: 'bg-yellow-400', textColor: 'text-yellow-600' }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Show loading state
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Load data from Google Sheets first
            loadDataFromGoogleSheets();
        }

        function loadDataFromGoogleSheets() {
            const script = document.createElement('script');
            const callbackName = 'loadCallback_' + Date.now();
            
            window[callbackName] = function(response) {
                if (response.success) {
                    // Load rooms data
                    if (response.rooms && response.rooms.length > 0) {
                        rooms = response.rooms.map(room => ({
                            name: room[0],
                            students: room[1] ? JSON.parse(room[1]) : []
                        }));
                        localStorage.setItem('rooms', JSON.stringify(rooms));
                    }
                    
                    // Load subjects data
                    if (response.subjects && response.subjects.length > 0) {
                        subjects = response.subjects.map(subject => ({
                            name: subject[0]
                        }));
                        localStorage.setItem('subjects', JSON.stringify(subjects));
                    }
                    
                    // Load attendance data
                    if (response.attendance && response.attendance.length > 0) {
                        const loadedAttendanceData = {};
                        response.attendance.forEach(record => {
                            const [date, room, subject, studentId, status] = record;
                            if (!loadedAttendanceData[date]) {
                                loadedAttendanceData[date] = {};
                            }
                            if (!loadedAttendanceData[date][room]) {
                                loadedAttendanceData[date][room] = {};
                            }
                            if (!loadedAttendanceData[date][room][subject]) {
                                loadedAttendanceData[date][room][subject] = {};
                            }
                            loadedAttendanceData[date][room][subject][studentId] = status;
                        });
                        attendanceData = loadedAttendanceData;
                        localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                    }
                }
                
                // Initialize UI components
                generateCalendar('calendar');
                generateCalendar('history-calendar');
                loadRoomsAndSubjects();
                updateRoomList();
                updateSubjectList();
                
                // Close loading dialog
                Swal.close();
                
                document.head.removeChild(script);
                delete window[callbackName];
            };
            
            const params = new URLSearchParams({
                action: 'loadAllData',
                callback: callbackName
            });
            
            script.src = `${GOOGLE_SCRIPT_URL}?${params.toString()}`;
            document.head.appendChild(script);
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Add active class to selected button
            const activeBtn = document.getElementById('tab-' + tabName);
            activeBtn.classList.add('bg-indigo-600', 'text-white');
            activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-100');
            
            // Refresh data when switching tabs
            loadDataFromGoogleSheets();
        }

        // Calendar generation
        function generateCalendar(containerId) {
            const container = document.getElementById(containerId);
            const today = new Date();
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                              '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            
            let html = `
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1, '${containerId}')" class="p-2 hover:bg-gray-200 rounded">‚óÄ</button>
                    <h3 class="text-lg font-semibold">${monthNames[month]} ${year}</h3>
                    <button onclick="changeMonth(1, '${containerId}')" class="p-2 hover:bg-gray-200 rounded">‚ñ∂</button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center">
                    <div class="font-semibold text-red-600">‡∏≠‡∏≤</div>
                    <div class="font-semibold">‡∏à</div>
                    <div class="font-semibold">‡∏≠</div>
                    <div class="font-semibold">‡∏û</div>
                    <div class="font-semibold">‡∏û‡∏§</div>
                    <div class="font-semibold">‡∏®</div>
                    <div class="font-semibold text-blue-600">‡∏™</div>
            `;
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const isCurrentMonth = date.getMonth() === month;
                const isToday = date.toDateString() === today.toDateString();
                const isPast = date <= today;
                const dateStr = date.toISOString().split('T')[0];
                const hasData = attendanceData[dateStr];
                
                let classes = 'calendar-day p-2 rounded cursor-pointer';
                
                if (!isCurrentMonth) {
                    classes += ' text-gray-300';
                } else if (containerId === 'calendar' && !isPast) {
                    classes += ' disabled';
                } else {
                    classes += ' hover:bg-gray-200';
                }
                
                if (isToday) {
                    classes += ' bg-blue-100 border-2 border-blue-500';
                }
                
                if (hasData) {
                    classes += ' has-data';
                }
                
                const clickHandler = (containerId === 'calendar' && isPast && isCurrentMonth) || 
                                   (containerId === 'history-calendar' && isCurrentMonth) 
                                   ? `onclick="selectDate('${dateStr}', '${containerId}')"` : '';
                
                html += `<div class="${classes}" ${clickHandler}>${date.getDate()}</div>`;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function changeMonth(direction, containerId) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar(containerId);
        }

        function selectDate(dateStr, containerId) {
            selectedDate = dateStr;
            
            // Update visual selection
            const container = document.getElementById(containerId);
            container.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            
            event.target.classList.add('selected');
            
            if (containerId === 'calendar') {
                // Reset room and subject selection when date changes
                document.getElementById('room-select').value = '';
                document.getElementById('subject-select').value = '';
                document.getElementById('student-list').classList.add('hidden');
                checkAndShowStudents();
            } else if (containerId === 'history-calendar') {
                // Reset history results when date is selected
                document.getElementById('history-results').classList.add('hidden');
            }
        }

        // Room and Subject management
        function loadRoomsAndSubjects() {
            const roomSelect = document.getElementById('room-select');
            const subjectSelect = document.getElementById('subject-select');
            const historyRoomSelect = document.getElementById('history-room-select');
            const historySubjectSelect = document.getElementById('history-subject-select');
            
            // Clear existing options
            [roomSelect, historyRoomSelect].forEach(select => {
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>';
                rooms.forEach(room => {
                    select.innerHTML += `<option value="${room.name}">${room.name}</option>`;
                });
            });
            
            [subjectSelect, historySubjectSelect].forEach(select => {
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>';
                subjects.forEach(subject => {
                    select.innerHTML += `<option value="${subject.name}">${subject.name}</option>`;
                });
            });
        }

        function checkAndShowStudents() {
            const roomName = document.getElementById('room-select').value;
            const subjectName = document.getElementById('subject-select').value;
            
            if (selectedDate && roomName && subjectName) {
                const room = rooms.find(r => r.name === roomName);
                if (room && room.students && room.students.length > 0) {
                    displayStudentList(room.students, roomName, subjectName);
                } else {
                    document.getElementById('student-list').classList.add('hidden');
                    Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ', 'warning');
                }
            } else {
                document.getElementById('student-list').classList.add('hidden');
            }
        }

        function displayStudentList(students, roomName, subjectName) {
            const tbody = document.getElementById('student-tbody');
            const dateStr = selectedDate;
            const existingData = attendanceData[dateStr]?.[roomName]?.[subjectName] || {};
            
            tbody.innerHTML = '';
            
            students.sort((a, b) => parseInt(a.number) - parseInt(b.number)).forEach(student => {
                const currentStatus = existingData[student.id] || 'present';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">${student.number}</td>
                    <td class="border border-gray-300 px-4 py-2">${student.id}</td>
                    <td class="border border-gray-300 px-4 py-2">${student.name}</td>
                    <td class="border border-gray-300 px-4 py-2">
                        <div class="flex justify-center gap-2">
                            ${Object.entries(statusConfig).map(([key, config]) => `
                                <button class="status-btn w-8 h-8 rounded-full text-sm font-bold ${currentStatus === key ? 'active ' + config.activeColor + ' text-white' : config.color + ' ' + config.textColor}"
                                        onclick="setStudentStatus('${student.id}', '${key}', this)"
                                        data-status="${key}">
                                    ${config.label}
                                </button>
                            `).join('')}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('student-list').classList.remove('hidden');
        }

        function setStudentStatus(studentId, status, button) {
            // Remove active class from all buttons in the same row
            const row = button.closest('tr');
            row.querySelectorAll('.status-btn').forEach(btn => {
                const btnStatus = btn.dataset.status;
                const config = statusConfig[btnStatus];
                btn.classList.remove('active', 'bg-green-400', 'bg-red-400', 'bg-purple-400', 'bg-orange-400', 'bg-yellow-400', 'text-white');
                btn.classList.add(config.color, config.textColor);
            });
            
            // Add active class to clicked button
            const config = statusConfig[status];
            button.classList.add('active', config.activeColor, 'text-white');
            button.classList.remove(config.color, config.textColor);
            
            // Store the status
            button.dataset.currentStatus = status;
        }

        // Attendance saving
        function saveAttendance() {
            const roomName = document.getElementById('room-select').value;
            const subjectName = document.getElementById('subject-select').value;
            
            if (!selectedDate || !roomName || !subjectName) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤', 'error');
                return;
            }
            
            const attendanceRecord = {};
            const rows = document.querySelectorAll('#student-tbody tr');
            
            rows.forEach(row => {
                const studentId = row.cells[1].textContent;
                const activeButton = row.querySelector('.status-btn.active');
                const status = activeButton ? activeButton.dataset.status : 'absent';
                attendanceRecord[studentId] = status;
            });
            
            // Save to local storage
            if (!attendanceData[selectedDate]) {
                attendanceData[selectedDate] = {};
            }
            if (!attendanceData[selectedDate][roomName]) {
                attendanceData[selectedDate][roomName] = {};
            }
            attendanceData[selectedDate][roomName][subjectName] = attendanceRecord;
            
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            // Save to Google Sheets
            const dataToSend = {
                action: 'saveAttendance',
                date: selectedDate,
                room: roomName,
                subject: subjectName,
                attendance: JSON.stringify(attendanceRecord)
            };
            
            sendToGoogleSheets(dataToSend);
        }

        // Google Sheets integration
        function sendToGoogleSheets(data, showLoading = true, showSuccess = true) {
            if (showLoading) {
                // Show loading state
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
            }
            
            const script = document.createElement('script');
            const callbackName = 'callback_' + Date.now();
            
            window[callbackName] = function(response) {
                if (showLoading) {
                    Swal.close(); // Close loading dialog
                }
                
                if (response.success) {
                    if (showSuccess) {
                        Swal.fire({
                            icon: 'success',
                            title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                            text: response.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                    generateCalendar('calendar');
                    generateCalendar('history-calendar');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + (response.error || 'Unknown error')
                    });
                }
                document.head.removeChild(script);
                delete window[callbackName];
            };
            
            // Ensure all data is properly stringified
            const processedData = {};
            Object.keys(data).forEach(key => {
                if (typeof data[key] === 'object' && data[key] !== null) {
                    processedData[key] = JSON.stringify(data[key]);
                } else {
                    processedData[key] = data[key];
                }
            });
            
            const params = new URLSearchParams({
                ...processedData,
                callback: callbackName
            });
            
            script.src = `${GOOGLE_SCRIPT_URL}?${params.toString()}`;
            document.head.appendChild(script);
        }

        // Room management
        function addRoom() {
            const roomName = document.getElementById('new-room-name').value.trim();
            if (!roomName) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
                return;
            }
            
            if (rooms.find(r => r.name === roomName)) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
                return;
            }
            
            rooms.push({ name: roomName, students: [] });
            rooms.sort((a, b) => a.name.localeCompare(b.name));
            localStorage.setItem('rooms', JSON.stringify(rooms));
            document.getElementById('new-room-name').value = '';
            updateRoomList();
            loadRoomsAndSubjects();
            
            // Auto save to Google Sheets
            const dataToSend = {
                action: 'saveRooms',
                rooms: JSON.stringify(rooms)
            };
            sendToGoogleSheets(dataToSend, false, false);
        }

        function updateRoomList() {
            const container = document.getElementById('room-list');
            container.innerHTML = '';
            
            rooms.forEach((room, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <span class="font-medium">${room.name} (${room.students ? room.students.length : 0} ‡∏Ñ‡∏ô)</span>
                    <div class="flex gap-2">
                        <button onclick="editRoom(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="deleteRoom(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">‡∏•‡∏ö</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function editRoom(index) {
            currentRoom = index;
            document.getElementById('modal-room-name').textContent = rooms[index].name;
            updateModalStudentList();
            document.getElementById('student-modal').classList.remove('hidden');
        }

        function deleteRoom(index) {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á "${rooms[index].name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    rooms.splice(index, 1);
                    rooms.sort((a, b) => a.name.localeCompare(b.name));
                    localStorage.setItem('rooms', JSON.stringify(rooms));
                    updateRoomList();
                    loadRoomsAndSubjects();
                    
                    // Save to Google Sheets
                    const dataToSend = {
                        action: 'saveRooms',
                        rooms: JSON.stringify(rooms)
                    };
                    sendToGoogleSheets(dataToSend, false, false);
                }
            });
        }

        function saveRooms() {
            const dataToSend = {
                action: 'saveRooms',
                rooms: JSON.stringify(rooms)
            };
            sendToGoogleSheets(dataToSend);
        }

        function clearAllRooms() {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading state
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    rooms = [];
                    localStorage.setItem('rooms', JSON.stringify(rooms));
                    updateRoomList();
                    loadRoomsAndSubjects();
                    
                    const dataToSend = {
                        action: 'clearAllRooms'
                    };
                    sendToGoogleSheets(dataToSend);
                }
            });
        }

        // Subject management
        function addSubject() {
            const subjectName = document.getElementById('new-subject-name').value.trim();
            if (!subjectName) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤', 'error');
                return;
            }
            
            if (subjects.find(s => s.name === subjectName)) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
                return;
            }
            
            subjects.push({ name: subjectName });
            subjects.sort((a, b) => a.name.localeCompare(b.name));
            localStorage.setItem('subjects', JSON.stringify(subjects));
            document.getElementById('new-subject-name').value = '';
            updateSubjectList();
            loadRoomsAndSubjects();
            
            // Save to Google Sheets
            const dataToSend = {
                action: 'saveSubjects',
                subjects: JSON.stringify(subjects)
            };
            sendToGoogleSheets(dataToSend, false, false);
        }

        function updateSubjectList() {
            const container = document.getElementById('subject-list');
            container.innerHTML = '';
            
            subjects.forEach((subject, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <span class="font-medium">${subject.name}</span>
                    <div class="flex gap-2">
                        <button onclick="editSubject(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="deleteSubject(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">‡∏•‡∏ö</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function editSubject(index) {
            Swal.fire({
                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤',
                input: 'text',
                inputValue: subjects[index].name,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed && result.value.trim()) {
                    subjects[index].name = result.value.trim();
                    subjects.sort((a, b) => a.name.localeCompare(b.name));
                    localStorage.setItem('subjects', JSON.stringify(subjects));
                    updateSubjectList();
                    loadRoomsAndSubjects();
                    
                    // Save to Google Sheets
                    const dataToSend = {
                        action: 'saveSubjects',
                        subjects: JSON.stringify(subjects)
                    };
                    sendToGoogleSheets(dataToSend, false, false);
                }
            });
        }

        function deleteSubject(index) {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ "${subjects[index].name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    subjects.splice(index, 1);
                    subjects.sort((a, b) => a.name.localeCompare(b.name));
                    localStorage.setItem('subjects', JSON.stringify(subjects));
                    updateSubjectList();
                    loadRoomsAndSubjects();
                    
                    // Save to Google Sheets
                    const dataToSend = {
                        action: 'saveSubjects',
                        subjects: JSON.stringify(subjects)
                    };
                    sendToGoogleSheets(dataToSend, false, false);
                }
            });
        }

        function saveSubjects() {
            const dataToSend = {
                action: 'saveSubjects',
                subjects: JSON.stringify(subjects)
            };
            sendToGoogleSheets(dataToSend);
        }

        function clearAllSubjects() {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading state
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    subjects = [];
                    localStorage.setItem('subjects', JSON.stringify(subjects));
                    updateSubjectList();
                    loadRoomsAndSubjects();
                    
                    const dataToSend = {
                        action: 'clearAllSubjects'
                    };
                    sendToGoogleSheets(dataToSend);
                }
            });
        }

        // Student management
        function addStudent() {
            const number = document.getElementById('student-number').value.trim();
            const id = document.getElementById('student-id').value.trim();
            const name = document.getElementById('student-name').value.trim();
            
            if (!number || !id || !name) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            
            if (!rooms[currentRoom].students) {
                rooms[currentRoom].students = [];
            }
            
            if (rooms[currentRoom].students.find(s => s.id === id)) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
                return;
            }
            
            rooms[currentRoom].students.push({ number, id, name });
            rooms[currentRoom].students.sort((a, b) => parseInt(a.number) - parseInt(b.number));
            localStorage.setItem('rooms', JSON.stringify(rooms));
            
            // Clear form
            document.getElementById('student-number').value = '';
            document.getElementById('student-id').value = '';
            document.getElementById('student-name').value = '';
            
            updateModalStudentList();
            updateRoomList();
        }

        function updateModalStudentList() {
            const tbody = document.getElementById('modal-student-list');
            tbody.innerHTML = '';
            
            if (!rooms[currentRoom].students) {
                rooms[currentRoom].students = [];
            }
            
            rooms[currentRoom].students.sort((a, b) => parseInt(a.number) - parseInt(b.number)).forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">${student.number}</td>
                    <td class="border border-gray-300 px-4 py-2">${student.id}</td>
                    <td class="border border-gray-300 px-4 py-2">${student.name}</td>
                    <td class="border border-gray-300 px-4 py-2 text-center">
                        <button onclick="editStudent(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-sm mr-2">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="deleteStudent(${index})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">‡∏•‡∏ö</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editStudent(index) {
            const student = rooms[currentRoom].students[index];
            
            Swal.fire({
                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                html: `
                    <input id="edit-number" class="swal2-input" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" value="${student.number}">
                    <input id="edit-id" class="swal2-input" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß" value="${student.id}">
                    <input id="edit-name" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" value="${student.name}">
                `,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                preConfirm: () => {
                    const number = document.getElementById('edit-number').value.trim();
                    const id = document.getElementById('edit-id').value.trim();
                    const name = document.getElementById('edit-name').value.trim();
                    
                    if (!number || !id || !name) {
                        Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                        return false;
                    }
                    
                    return { number, id, name };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    rooms[currentRoom].students[index] = result.value;
                    rooms[currentRoom].students.sort((a, b) => parseInt(a.number) - parseInt(b.number));
                    localStorage.setItem('rooms', JSON.stringify(rooms));
                    updateModalStudentList();
                    updateRoomList();
                }
            });
        }

        function deleteStudent(index) {
            const student = rooms[currentRoom].students[index];
            
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô "${student.name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    rooms[currentRoom].students.splice(index, 1);
                    rooms[currentRoom].students.sort((a, b) => parseInt(a.number) - parseInt(b.number));
                    localStorage.setItem('rooms', JSON.stringify(rooms));
                    updateModalStudentList();
                    updateRoomList();
                }
            });
        }

        function saveStudents() {
            const dataToSend = {
                action: 'saveStudents',
                roomName: rooms[currentRoom].name,
                students: JSON.stringify(rooms[currentRoom].students)
            };
            sendToGoogleSheets(dataToSend);
            
            // Also update the rooms data in Google Sheets
            const roomsDataToSend = {
                action: 'saveRooms',
                rooms: JSON.stringify(rooms)
            };
            sendToGoogleSheets(roomsDataToSend);
        }

        function closeStudentModal() {
            document.getElementById('student-modal').classList.add('hidden');
        }

        // Excel import
        function importFromExcel() {
            const file = document.getElementById('excel-file').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    let importedCount = 0;
                    
                    for (let i = 1; i < jsonData.length; i++) { // Skip header row
                        const row = jsonData[i];
                        if (row[0] && row[1] && row[2]) { // Check if all required columns have data
                            const number = row[0].toString().trim();
                            const id = row[1].toString().trim();
                            const name = row[2].toString().trim();
                            
                            // Check if student ID already exists
                            if (!rooms[currentRoom].students.find(s => s.id === id)) {
                                rooms[currentRoom].students.push({ number, id, name });
                                importedCount++;
                            }
                        }
                    }
                    
                    if (importedCount > 0) {
                        rooms[currentRoom].students.sort((a, b) => parseInt(a.number) - parseInt(b.number));
                        localStorage.setItem('rooms', JSON.stringify(rooms));
                        updateModalStudentList();
                        updateRoomList();
                        
                        // Save to Google Sheets automatically
                        const dataToSend = {
                            action: 'saveRooms',
                            rooms: JSON.stringify(rooms)
                        };
                        
                        // Show loading state
                        Swal.fire({
                            title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            showConfirmButton: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });
                        
                        const script = document.createElement('script');
                        const callbackName = 'importCallback_' + Date.now();
                        
                        window[callbackName] = function(response) {
                            Swal.close();
                            
                            if (response.success) {
                                // Close modal and show success message
                                closeStudentModal();
                                Swal.fire({
                                    icon: 'success',
                                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                                    text: `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${importedCount} ‡∏Ñ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + (response.error || 'Unknown error')
                                });
                            }
                            
                            document.head.removeChild(script);
                            delete window[callbackName];
                        };
                        
                        const params = new URLSearchParams({
                            ...dataToSend,
                            callback: callbackName
                        });
                        
                        script.src = `${GOOGLE_SCRIPT_URL}?${params.toString()}`;
                        document.head.appendChild(script);
                        
                    } else {
                        Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', 'info');
                    }
                    
                } catch (error) {
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏î‡πâ', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // History management
        function loadHistory() {
            const date = selectedDate;
            const room = document.getElementById('history-room-select').value;
            const subject = document.getElementById('history-subject-select').value;
            
            if (!date || !room || !subject) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤', 'error');
                return;
            }
            
            const historyData = attendanceData[date]?.[room]?.[subject];
            const roomData = rooms.find(r => r.name === room);
            
            if (!historyData || !roomData) {
                Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'info');
                document.getElementById('history-results').classList.add('hidden');
                return;
            }
            
            displayHistoryResults(roomData.students, historyData);
        }

        function deleteSelectedHistory() {
            const date = selectedDate;
            const room = document.getElementById('history-room-select').value;
            const subject = document.getElementById('history-subject-select').value;
            
            if (!date || !room || !subject) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤', 'error');
                return;
            }
            
            const historyData = attendanceData[date]?.[room]?.[subject];
            
            if (!historyData) {
                Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'info');
                return;
            }
            
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date} ‡∏´‡πâ‡∏≠‡∏á ${room} ‡∏ß‡∏¥‡∏ä‡∏≤ ${subject} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading state
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Delete from Google Sheets first
                    const script = document.createElement('script');
                    const callbackName = 'deleteCallback_' + Date.now();
                    
                    window[callbackName] = function(response) {
                        Swal.close();
                        
                        if (response.success) {
                            // Delete from local storage after successful deletion from Google Sheets
                            delete attendanceData[date][room][subject];
                            
                            // Clean up empty objects
                            if (Object.keys(attendanceData[date][room]).length === 0) {
                                delete attendanceData[date][room];
                            }
                            if (Object.keys(attendanceData[date]).length === 0) {
                                delete attendanceData[date];
                            }
                            
                            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                            
                            // Hide results and refresh calendar
                            document.getElementById('history-results').classList.add('hidden');
                            generateCalendar('calendar');
                            generateCalendar('history-calendar');
                            
                            Swal.fire({
                                icon: 'success',
                                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                                text: '‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                                text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + (response.error || 'Unknown error')
                            });
                        }
                        
                        document.head.removeChild(script);
                        delete window[callbackName];
                    };
                    
                    const params = new URLSearchParams({
                        action: 'deleteAttendance',
                        date: date,
                        room: room,
                        subject: subject,
                        callback: callbackName
                    });
                    
                    script.src = `${GOOGLE_SCRIPT_URL}?${params.toString()}`;
                    document.head.appendChild(script);
                }
            });
        }

        function deleteAllHistory() {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#dc2626'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading state
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Clear local storage
                    attendanceData = {};
                    localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                    
                    // Delete from Google Sheets
                    const dataToSend = {
                        action: 'deleteAllAttendance'
                    };
                    
                    sendToGoogleSheets(dataToSend);
                    
                    // Hide results and refresh calendar
                    document.getElementById('history-results').classList.add('hidden');
                    generateCalendar('calendar');
                    generateCalendar('history-calendar');
                }
            });
        }

        function displayHistoryResults(students, historyData) {
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = '';
            
            students.sort((a, b) => parseInt(a.number) - parseInt(b.number)).forEach(student => {
                const status = historyData[student.id] || 'absent';
                const config = statusConfig[status];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">${student.number}</td>
                    <td class="border border-gray-300 px-4 py-2">${student.id}</td>
                    <td class="border border-gray-300 px-4 py-2">${student.name}</td>
                    <td class="border border-gray-300 px-4 py-2 text-center">
                        <span class="inline-block w-8 h-8 rounded-full ${config.activeColor} text-white text-sm font-bold leading-8">
                            ${config.label}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('history-results').classList.remove('hidden');
        }

        // Event listeners
        document.getElementById('room-select').addEventListener('change', checkAndShowStudents);
        document.getElementById('subject-select').addEventListener('change', checkAndShowStudents);
        document.getElementById('history-room-select').addEventListener('change', function() {
            document.getElementById('history-results').classList.add('hidden');
        });
        document.getElementById('history-subject-select').addEventListener('change', function() {
            document.getElementById('history-results').classList.add('hidden');
        });
    </script>


<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96cf8331f79d2dc0',t:'MTc1NDgyOTExMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
